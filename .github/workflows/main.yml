name: Windows Worker with RDP Localhost (No Tunnel)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: worker
  cancel-in-progress: true

jobs:
  worker:
    runs-on: windows-latest
    timeout-minutes: 90  # Paksa stop setelah 90 menit kalau bot.py masih jalan/hang

    steps:
      - name: Enable RDP (Silent)
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 > $null 2>&1
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" > $null 2>&1

      - name: Set Simple RDP Credentials (Silent)
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          $user = "V"
          $password = "Root123"
          
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (-not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $user -Password $securePassword > $null 2>&1
          } else {
              Set-LocalUser -Name $user -Password $securePassword > $null 2>&1
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue > $null 2>&1

      - name: Setup Python (ensure installed & up-to-date)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # Ganti ke '3.13', '3.11', dll kalau butuh versi lain
          cache: 'pip'  # Optional: cache pip dependencies kalau bot.py butuh install package

      - name: Download package (silent)
        shell: powershell
        env:
          SRC_URL: ${{ secrets.LINK }}
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "$Env:SRC_URL" -OutFile "app.7z" > $null 2>&1

      - name: Extract package (silent)
        shell: powershell
        env:
          ARCHIVE_KEY: ${{ secrets.PSWD }}
        run: |
          & "C:\Program Files\7-Zip\7z.exe" x app.7z -p"$Env:ARCHIVE_KEY" -oextracted -y > $null 2>&1

      - name: Run bot.py (STEALTH)
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          $env:NODE_NO_WARNINGS = "1"

          # Cari bot.py recurse di folder extracted
          $botFile = Get-ChildItem extracted -Recurse -Filter "bot.py" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($botFile) {
              # Jalankan dengan python (yang dari setup-python)
              cmd /c "python `"$($botFile.FullName)`" > nul 2>&1"
          } else {
              # Optional: kalau bot.py nggak ketemu, bisa tambah pesan silent atau exit
              exit 0
          }

      # Job akan mati otomatis setelah bot.py selesai (atau timeout 90 menit)
